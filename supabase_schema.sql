-- 1. CLEANUP (Optional, use carefully if resetting)
-- DROP TABLE IF EXISTS telemetry;
-- DROP TABLE IF EXISTS drives;
-- DROP TABLE IF EXISTS charges;

-- 2. TELEMETRY TABLE (High frequency data from OVMS Logger)
CREATE TABLE IF NOT EXISTS telemetry (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  vehicle_id TEXT NOT NULL,
  timestamp BIGINT NOT NULL, -- Unix timestamp (ms) from the car/logger
  
  -- Battery & Range (Specific to i3)
  soc FLOAT,                 -- State of Charge %
  range FLOAT,               -- Display Range (km)
  est_range FLOAT,           -- Estimated Range based on history (km)
  ideal_range FLOAT,         -- Rated/Ideal Range (km)
  
  -- Electrical
  voltage FLOAT,             -- Battery Voltage (V)
  current FLOAT,             -- Battery Current (A)
  power FLOAT,               -- Power (kW)
  charge_state TEXT,         -- 'charging', 'done', 'stopped', 'top-off'
  
  -- Driving Stats
  speed FLOAT,               -- km/h
  odometer FLOAT,            -- Total distance (km)
  
  -- Temperatures (Critical for EV health)
  temp_battery FLOAT,        -- Battery Temp (C)
  temp_motor FLOAT,          -- Motor Temp (C)
  temp_ambient FLOAT,        -- Ambient Temp (C)
  
  -- Location
  latitude FLOAT,
  longitude FLOAT,
  elevation FLOAT,
  location_name TEXT         -- Optional, reverse geocoded name
);

-- Optimize fetching the latest status
CREATE INDEX IF NOT EXISTS idx_telemetry_vid_ts ON telemetry (vehicle_id, timestamp DESC);


-- 3. DRIVES TABLE (Aggregated sessions)
-- Note: Requires a background worker or trigger to populate from telemetry
CREATE TABLE IF NOT EXISTS drives (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  vehicle_id TEXT NOT NULL,
  start_date TIMESTAMPTZ NOT NULL,
  end_date TIMESTAMPTZ,
  
  distance FLOAT,            -- km
  duration FLOAT,            -- minutes
  consumption FLOAT,         -- kWh
  efficiency FLOAT,          -- Wh/km
  
  start_soc FLOAT,
  end_soc FLOAT,
  
  path JSONB                 -- Array of {lat, lng, speed} coordinates
);

CREATE INDEX IF NOT EXISTS idx_drives_start_date ON drives (start_date DESC);


-- 4. CHARGES TABLE (Aggregated sessions)
-- Note: Requires a background worker or trigger to populate from telemetry
CREATE TABLE IF NOT EXISTS charges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  vehicle_id TEXT NOT NULL,
  date TIMESTAMPTZ NOT NULL,
  
  location TEXT,
  added_kwh FLOAT,
  duration FLOAT,            -- minutes
  cost FLOAT,                -- Calculated cost
  
  avg_power FLOAT,
  max_power FLOAT,
  
  chart_data JSONB           -- Array of {time, power, soc} for graphing
);

CREATE INDEX IF NOT EXISTS idx_charges_date ON charges (date DESC);


-- 5. ROW LEVEL SECURITY (RLS)
-- Enable security
ALTER TABLE telemetry ENABLE ROW LEVEL SECURITY;
ALTER TABLE drives ENABLE ROW LEVEL SECURITY;
ALTER TABLE charges ENABLE ROW LEVEL SECURITY;

-- POLICIES
-- 1. Allow Public Read Access (For the dashboard viewer)
-- In a production multi-user app, you would change USING (true) to checks against auth.uid()
CREATE POLICY "Enable read access for all users" ON telemetry FOR SELECT USING (true);
CREATE POLICY "Enable read access for all users" ON drives FOR SELECT USING (true);
CREATE POLICY "Enable read access for all users" ON charges FOR SELECT USING (true);

-- 2. Allow Insert (Backend Logger needs Service Role Key to bypass RLS, or use this policy for specific authenticated users)
-- The Node.js logger using the SERVICE_KEY bypasses RLS automatically.
-- If you use the ANON_KEY for the logger, you need to uncomment the following:
-- CREATE POLICY "Enable insert for authenticated users" ON telemetry FOR INSERT WITH CHECK (true);
