
-- Clear existing schema to ensure clean slate
DROP TABLE IF EXISTS telemetry;
DROP TABLE IF EXISTS drives;
DROP TABLE IF EXISTS charges;

-- 1. Telemetry Table: Real-time mapping of OVMS/i3 metrics
CREATE TABLE telemetry (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  vehicle_id TEXT NOT NULL,
  timestamp BIGINT NOT NULL,
  
  -- Battery & Range (from metrics_i3.csv v.b.*)
  soc FLOAT,                 -- v.b.soc (%)
  soh FLOAT,                 -- v.b.soh (%)
  voltage FLOAT,             -- v.b.voltage (V)
  current FLOAT,             -- v.b.current (A)
  power FLOAT,               -- v.b.power (kW)
  capacity_ah FLOAT,         -- v.b.cac (Ah)
  est_range FLOAT,           -- v.b.range.est (km)
  ideal_range FLOAT,         -- v.b.range.ideal (km)
  range_full FLOAT,          -- v.b.range.full (km)
  
  -- i3 Specific Ranges (xi3.v.b.range.*)
  range_bc FLOAT,            -- xi3.v.b.range.bc
  range_comfort FLOAT,       -- xi3.v.b.range.comfort
  range_ecopro FLOAT,        -- xi3.v.b.range.ecopro
  range_ecoproplus FLOAT,    -- xi3.v.b.range.ecoproplus
  
  -- 12V System (v.b.12v.*)
  voltage_12v FLOAT,         
  current_12v FLOAT,         
  
  -- Charging (v.c.* and xi3.v.c.*)
  charge_state TEXT,         -- v.c.state (charging, stopped, etc.)
  charge_kwh FLOAT,          -- v.c.kwh (kWh)
  charge_temp FLOAT,         -- xi3.v.c.temp.gatedriver or v.c.temp
  charge_pilot_a FLOAT,      -- xi3.v.c.pilotsignal (A)
  charge_plug_status TEXT,   -- xi3.v.c.chargeplugstatus
  
  -- Driving & GPS (v.p.*)
  speed FLOAT,               -- v.p.speed (km/h)
  odometer FLOAT,            -- v.p.odometer (km)
  latitude FLOAT,            
  longitude FLOAT,           
  elevation FLOAT,           -- v.p.altitude (m)
  direction FLOAT,           -- v.p.direction (°)
  gps_lock BOOLEAN,          -- v.p.gpslock
  gps_sats INT,              -- v.p.satcount
  trip_consumption FLOAT,    -- xi3.v.p.tripconsumption (Wh/km)
  
  -- Temperatures (v.e.*, v.b.*, v.m.*)
  temp_battery FLOAT,        -- v.b.temp (°C)
  temp_motor FLOAT,          -- v.m.temp (°C)
  temp_ambient FLOAT,        -- v.e.temp (°C)
  inside_temp FLOAT,         -- v.e.cabintemp (°C)
  inverter_temp FLOAT,       -- v.i.temp (°C)
  
  -- Status (v.e.*)
  locked BOOLEAN,            -- v.e.locked
  car_on BOOLEAN,            -- v.e.on
  gear TEXT,                 -- v.e.gear
  park_time FLOAT,           -- v.e.parktime (Sec)
  drive_time FLOAT,          -- v.e.drivetime (Sec)
  
  raw_metrics JSONB,
  car_metrics JSONB
);

CREATE INDEX idx_telemetry_vid_ts ON telemetry (vehicle_id, timestamp DESC);

-- 2. Drives Table
CREATE TABLE drives (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  vehicle_id TEXT NOT NULL,
  start_date TIMESTAMPTZ NOT NULL,
  end_date TIMESTAMPTZ,
  distance FLOAT,            -- km
  duration FLOAT,            -- min
  start_soc FLOAT,
  end_soc FLOAT,
  start_odometer FLOAT,
  end_odometer FLOAT,
  consumption FLOAT,         -- kWh
  efficiency FLOAT,          -- Wh/km
  path JSONB                 
);

-- 3. Charges Table
CREATE TABLE charges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  vehicle_id TEXT NOT NULL,
  date TIMESTAMPTZ NOT NULL,
  end_date TIMESTAMPTZ,
  location TEXT,
  added_kwh FLOAT,
  duration FLOAT,            
  start_soc FLOAT,
  end_soc FLOAT,
  max_power FLOAT,
  chart_data JSONB
);

-- RLS & Permissions
ALTER TABLE telemetry ENABLE ROW LEVEL SECURITY;
ALTER TABLE drives ENABLE ROW LEVEL SECURITY;
ALTER TABLE charges ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public Read" ON telemetry FOR SELECT USING (true);
CREATE POLICY "Public Insert" ON telemetry FOR INSERT WITH CHECK (true);
CREATE POLICY "Public Read Drives" ON drives FOR SELECT USING (true);
CREATE POLICY "Public Insert Drives" ON drives FOR INSERT WITH CHECK (true);
CREATE POLICY "Public Update Drives" ON drives FOR UPDATE USING (true);
CREATE POLICY "Public Read Charges" ON charges FOR SELECT USING (true);
CREATE POLICY "Public Insert Charges" ON charges FOR INSERT WITH CHECK (true);
CREATE POLICY "Public Update Charges" ON charges FOR UPDATE USING (true);
